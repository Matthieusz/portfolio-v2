---
import { getNowPlaying, type NowPlayingData } from "../lib/spotify";

const initialData = await getNowPlaying();
console.log("Spotify Now Playing Initial Data:", initialData);
---

<div
  id="spotify-now-playing"
  class="bg-card border-border relative flex h-full flex-col gap-3 overflow-hidden rounded-lg border p-4"
  data-initial={JSON.stringify(initialData)}
  style={initialData?.albumImageUrl ? `--album-color: var(--primary)` : ""}
>
  <!-- Album color gradient overlay -->
  <div
    id="spotify-gradient"
    class="pointer-events-none absolute inset-0 opacity-10"
    style="background: radial-gradient(ellipse at top left, var(--album-color, transparent) 0%, transparent 70%)"
  >
  </div>

  <div class="relative z-10">
    <h3
      class="text-muted-foreground text-xs font-medium tracking-wider uppercase flex items-center gap-2"
    >
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-music"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 17a3 3 0 1 0 6 0a3 3 0 0 0 -6 0" /><path d="M13 17a3 3 0 1 0 6 0a3 3 0 0 0 -6 0" /><path d="M9 17v-13h10v13" /><path d="M9 8h10" /></svg>
       BEEP BOOP
    </h3>
  </div>
  <div id="spotify-content" class="relative z-10 w-full min-w-0">
    {
      initialData ? (
        <div class="flex gap-4">
          <a
            id="spotify-album-link"
            href={initialData.songUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="relative shrink-0"
          >
            <img
              id="spotify-album-img"
              src={initialData.albumImageUrl}
              alt={`${initialData.album} album cover`}
              width={96}
              height={96}
              class="rounded-md"
              crossorigin="anonymous"
            />
            <!-- Animated equalizer overlay when playing -->
            {initialData.isPlaying && (
              <div
                id="spotify-equalizer"
                class="absolute inset-0 flex items-end justify-center gap-0.5 rounded-md bg-black/40 p-2"
              >
                <span class="equalizer-bar bg-primary h-3 w-1 rounded-full" />
                <span class="equalizer-bar bg-primary h-5 w-1 rounded-full" />
                <span class="equalizer-bar bg-primary h-4 w-1 rounded-full" />
                <span class="equalizer-bar bg-primary h-6 w-1 rounded-full" />
                <span class="equalizer-bar bg-primary h-3 w-1 rounded-full" />
              </div>
            )}
          </a>

          <div class="flex w-full min-w-0 flex-1 flex-col">
            <div class="text-muted-foreground mb-1 flex items-center gap-2 text-xs">
              <svg
                class="h-4 w-4 text-green-500"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z" />
              </svg>
              <span id="spotify-status">
                {initialData.isPlaying ? (
                  <span class="flex items-center gap-1">Now Playing</span>
                ) : (
                  <span>Last Played</span>
                )}
              </span>
            </div>

            <div id="spotify-title-container" class="marquee-container overflow-hidden">
              <a
                id="spotify-title"
                href={initialData.songUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="hover:text-primary text-foreground marquee-content inline-block whitespace-nowrap font-medium transition-colors"
              >
                {initialData.title}
              </a>
            </div>

            <p
              id="spotify-artist"
              class="text-muted-foreground truncate text-sm"
            >
              {initialData.artist}
            </p>

            <div
              id="spotify-progress-container"
              class:list={[
                "mt-2 flex items-center gap-2 text-xs",
                { hidden: !initialData.isPlaying },
              ]}
            >
              <span
                id="spotify-current-time"
                class="text-muted-foreground tabular-nums"
              >
                {initialData.progress
                  ? `${Math.floor(initialData.progress / 60000)}:${String(Math.floor((initialData.progress % 60000) / 1000)).padStart(2, "0")}`
                  : "0:00"}
              </span>
              <div class="bg-muted h-1 flex-1 overflow-hidden rounded-full">
                <div
                  id="spotify-progress-bar"
                  class="bg-primary linear h-full rounded-full transition-[width] duration-1000"
                  style={`width: ${initialData.progress && initialData.duration ? (initialData.progress / initialData.duration) * 100 : 0}%`}
                />
              </div>
              <span
                id="spotify-duration"
                class="text-muted-foreground tabular-nums"
              >
                {initialData.duration
                  ? `${Math.floor(initialData.duration / 60000)}:${String(Math.floor((initialData.duration % 60000) / 1000)).padStart(2, "0")}`
                  : "0:00"}
              </span>
            </div>
          </div>
        </div>

        <!-- Previous & Up Next -->
        <div class="border-border mt-4 flex flex-col gap-2 border-t pt-3">
          {/* Previous Track */}
          <div id="spotify-previous" class={`flex items-center gap-3 ${initialData.previousTrack ? '' : 'hidden'}`}>
            <span class="text-muted-foreground w-16 shrink-0 text-xs">Previous</span>
            <a
              id="spotify-previous-link"
              href={initialData.previousTrack?.songUrl ?? "#"}
              target="_blank"
              rel="noopener noreferrer"
              class="flex min-w-0 flex-1 items-center gap-2"
            >
              <img
                id="spotify-previous-img"
                src={initialData.previousTrack?.albumImageUrl ?? ""}
                alt=""
                class="h-8 w-8 shrink-0 rounded"
                width={32}
                height={32}
              />
              <div class="min-w-0 flex-1">
                <p id="spotify-previous-title" class="text-foreground truncate text-sm font-medium">
                  {initialData.previousTrack?.title ?? ""}
                </p>
                <p id="spotify-previous-artist" class="text-muted-foreground truncate text-xs">
                  {initialData.previousTrack?.artist ?? ""}
                </p>
              </div>
            </a>
          </div>

          {/* Up Next */}
          <div id="spotify-upnext" class={`flex items-center gap-3 ${initialData.upNext ? '' : 'hidden'}`}>
            <span class="text-muted-foreground w-16 shrink-0 text-xs">Up Next</span>
            <a
              id="spotify-upnext-link"
              href={initialData.upNext?.songUrl ?? "#"}
              target="_blank"
              rel="noopener noreferrer"
              class="flex min-w-0 flex-1 items-center gap-2"
            >
              <img
                id="spotify-upnext-img"
                src={initialData.upNext?.albumImageUrl ?? ""}
                alt=""
                class="h-8 w-8 shrink-0 rounded"
                width={32}
                height={32}
              />
              <div class="min-w-0 flex-1">
                <p id="spotify-upnext-title" class="text-foreground truncate text-sm font-medium">
                  {initialData.upNext?.title ?? ""}
                </p>
                <p id="spotify-upnext-artist" class="text-muted-foreground truncate text-xs">
                  {initialData.upNext?.artist ?? ""}
                </p>
              </div>
            </a>
          </div>
        </div>
      ) : (
        <div class="text-muted-foreground flex items-center gap-3">
          <svg class="h-8 w-8" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z" />
          </svg>
          <span>Not playing anything</span>
        </div>
      )
    }
  </div>
</div>

<style>
  @keyframes equalize {
    0%,
    100% {
      height: 0.5rem;
    }
    50% {
      height: 1.5rem;
    }
  }

  @keyframes marquee {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(-50%);
    }
  }

  .equalizer-bar {
    animation: equalize 0.8s ease-in-out infinite;
  }

  .equalizer-bar:nth-child(1) {
    animation-delay: 0s;
  }
  .equalizer-bar:nth-child(2) {
    animation-delay: 0.15s;
  }
  .equalizer-bar:nth-child(3) {
    animation-delay: 0.3s;
  }
  .equalizer-bar:nth-child(4) {
    animation-delay: 0.45s;
  }
  .equalizer-bar:nth-child(5) {
    animation-delay: 0.6s;
  }

  .marquee-container {
    position: relative;
  }

  .marquee-content.scrolling {
    animation: marquee 10s linear infinite;
  }

  .marquee-content.scrolling::after {
    content: attr(data-text);
    padding-left: 3rem;
  }
</style>

<script>
  interface TrackInfo {
    title: string;
    artist: string;
    album: string;
    albumImageUrl: string;
    songUrl: string;
  }

  interface AudioFeatures {
    energy: number;
    tempo: number;
    danceability: number;
    valence: number;
    mood: string;
  }

  interface NowPlayingData {
    isPlaying: boolean;
    title: string;
    artist: string;
    album: string;
    albumImageUrl: string;
    songUrl: string;
    progress?: number;
    duration?: number;
    playedAt?: string;
    trackId?: string;
    audioFeatures?: AudioFeatures;
    previousTrack?: TrackInfo;
    upNext?: TrackInfo;
  }

  const POLL_INTERVAL = 10000;
  const PROGRESS_UPDATE_INTERVAL = 1000;

  let currentData: NowPlayingData | null = null;
  let localProgress = 0;
  let progressInterval: ReturnType<typeof setInterval> | null = null;

  function formatTime(ms: number): string {
    const seconds = Math.floor(ms / 1000);
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, "0")}`;
  }

  // Extract dominant color from album art
  function extractColor(img: HTMLImageElement): string {
    try {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      if (!ctx) return "hsl(var(--primary))";

      canvas.width = 50;
      canvas.height = 50;
      ctx.drawImage(img, 0, 0, 50, 50);

      const imageData = ctx.getImageData(0, 0, 50, 50).data;
      let r = 0,
        g = 0,
        b = 0,
        count = 0;

      for (let i = 0; i < imageData.length; i += 16) {
        // Sample every 4th pixel
        const pr = imageData[i];
        const pg = imageData[i + 1];
        const pb = imageData[i + 2];
        // Skip very dark or very light pixels
        if (pr + pg + pb > 60 && pr + pg + pb < 700) {
          r += pr;
          g += pg;
          b += pb;
          count++;
        }
      }

      if (count === 0) return "hsl(var(--primary))";

      r = Math.round(r / count);
      g = Math.round(g / count);
      b = Math.round(b / count);

      return `rgb(${r}, ${g}, ${b})`;
    } catch {
      return "hsl(var(--primary))";
    }
  }

  function updateAlbumColor(img: HTMLImageElement) {
    const container = document.getElementById("spotify-now-playing");
    const gradient = document.getElementById("spotify-gradient");
    if (!container || !gradient) return;

    const color = extractColor(img);
    container.style.setProperty("--album-color", color);
  }

  function updateProgressUI() {
    const progressBar = document.getElementById("spotify-progress-bar");
    const currentTimeEl = document.getElementById("spotify-current-time");

    if (
      !currentData?.isPlaying ||
      !currentData.duration ||
      !progressBar ||
      !currentTimeEl
    ) {
      return;
    }

    const percentage = Math.min(
      (localProgress / currentData.duration) * 100,
      100,
    );
    progressBar.style.width = `${percentage}%`;
    currentTimeEl.textContent = formatTime(localProgress);
  }

  function startProgressAnimation() {
    if (progressInterval) {
      clearInterval(progressInterval);
    }

    progressInterval = setInterval(() => {
      if (currentData?.isPlaying && currentData.duration) {
        localProgress = Math.min(localProgress + 1000, currentData.duration);
        updateProgressUI();
      }
    }, PROGRESS_UPDATE_INTERVAL);
  }

  // Check if title needs scrolling
  function checkTitleScroll() {
    const container = document.getElementById("spotify-title-container");
    const title = document.getElementById("spotify-title") as HTMLAnchorElement | null;
    
    if (container && title) {
      const needsScroll = title.scrollWidth > container.clientWidth;
      
      if (needsScroll) {
        title.classList.add("scrolling");
        title.dataset.text = title.textContent || "";
      } else {
        title.classList.remove("scrolling");
      }
    }
  }

  // Update a track row (previous/upnext)
  function updateTrackRow(prefix: string, track?: TrackInfo) {
    const container = document.getElementById(prefix);
    const link = document.getElementById(`${prefix}-link`) as HTMLAnchorElement | null;
    const img = document.getElementById(`${prefix}-img`) as HTMLImageElement | null;
    const title = document.getElementById(`${prefix}-title`);
    const artist = document.getElementById(`${prefix}-artist`);

    if (container) {
      container.classList.toggle("hidden", !track);
    }

    if (track) {
      if (link) link.href = track.songUrl;
      if (img) img.src = track.albumImageUrl;
      if (title) title.textContent = track.title;
      if (artist) artist.textContent = track.artist;
    }
  }

  function updateUI(data: NowPlayingData | null) {
    const albumLink = document.getElementById(
      "spotify-album-link",
    ) as HTMLAnchorElement | null;
    const albumImg = document.getElementById(
      "spotify-album-img",
    ) as HTMLImageElement | null;
    const equalizer = document.getElementById("spotify-equalizer");
    const statusEl = document.getElementById("spotify-status");
    const titleEl = document.getElementById(
      "spotify-title",
    ) as HTMLAnchorElement | null;
    const artistEl = document.getElementById("spotify-artist");
    const progressContainer = document.getElementById(
      "spotify-progress-container",
    );
    const durationEl = document.getElementById("spotify-duration");
    const moodEl = document.getElementById("spotify-mood");
    const tempoEl = document.getElementById("spotify-tempo");

    if (!data) return;

    const songChanged =
      !currentData ||
      currentData.title !== data.title ||
      currentData.artist !== data.artist;

    if (songChanged) {
      if (albumLink) albumLink.href = data.songUrl;
      if (albumImg) {
        albumImg.src = data.albumImageUrl;
        albumImg.alt = `${data.album} album cover`;
        albumImg.onload = () => updateAlbumColor(albumImg);
      }
      if (titleEl) {
        titleEl.href = data.songUrl;
        titleEl.textContent = data.title;
        titleEl.dataset.text = data.title;
        // Check scroll after DOM update
        setTimeout(checkTitleScroll, 0);
      }
      if (artistEl) artistEl.textContent = data.artist;
      if (durationEl && data.duration)
        durationEl.textContent = formatTime(data.duration);

      // Update audio features
      if (data.audioFeatures) {
        if (moodEl) moodEl.textContent = data.audioFeatures.mood;
        if (tempoEl)
          tempoEl.textContent = `${Math.round(data.audioFeatures.tempo)} BPM`;
      }

      // Update previous track
      updateTrackRow("spotify-previous", data.previousTrack);
      
      // Update up next track
      updateTrackRow("spotify-upnext", data.upNext);
    }

    // Update equalizer visibility
    if (equalizer) {
      equalizer.classList.toggle("hidden", !data.isPlaying);
    }

    if (statusEl) {
      if (data.isPlaying) {
        statusEl.innerHTML = `<span class="flex items-center gap-1">Now Playing</span>`;
      } else {
        statusEl.innerHTML = "<span>Last Played</span>";
      }
    }

    if (progressContainer) {
      progressContainer.classList.toggle("hidden", !data.isPlaying);
    }

    if (data.progress !== undefined) {
      localProgress = data.progress;
    }

    currentData = data;
    updateProgressUI();
  }

  async function fetchNowPlaying() {
    try {
      const response = await fetch("/api/spotify/now-playing");
      const data: NowPlayingData | null = await response.json();
      updateUI(data);
    } catch (error) {
      console.error("Failed to fetch now playing:", error);
    }
  }

  // Initialize
  const container = document.getElementById("spotify-now-playing");
  const initialDataStr = container?.dataset.initial;
  const albumImg = document.getElementById(
    "spotify-album-img",
  ) as HTMLImageElement | null;

  if (initialDataStr) {
    try {
      currentData = JSON.parse(initialDataStr);
      if (currentData?.progress) {
        localProgress = currentData.progress;
      }
      updateProgressUI();

      // Extract color on load
      if (albumImg && albumImg.complete) {
        updateAlbumColor(albumImg);
      } else if (albumImg) {
        albumImg.onload = () => updateAlbumColor(albumImg);
      }
    } catch (error) {
      console.error("Failed to parse initial data:", error);
    }
  }

  // Initial check and recheck on window resize
  checkTitleScroll();
  window.addEventListener("resize", checkTitleScroll);

  startProgressAnimation();
  setInterval(fetchNowPlaying, POLL_INTERVAL);
</script>
