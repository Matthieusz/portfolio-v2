---
interface Props {
  lat?: number;
  lng?: number;
  zoom?: number;
  label?: string;
}

const {
  lat = 52.4064,
  lng = 16.9352,
  zoom = 12,
  label = "Pozna≈Ñ, Poland",
} = Astro.props;
---

<div
  id="location-map"
  class="bg-card border-border relative flex h-full min-h-60 w-full flex-col overflow-hidden rounded-lg border p-1"
  data-lat={lat}
  data-lng={lng}
  data-zoom={zoom}
  data-label={label}
>
  <h3
    class="text-muted-foreground mb-3 flex items-center justify-between gap-2 px-2 pt-2 text-xs font-medium tracking-wider uppercase"
  >
    <span class="flex items-center gap-2">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="var(--primary)"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="icon icon-tabler icons-tabler-outline icon-tabler-map-pin"
        ><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path
          d="M9 11a3 3 0 1 0 6 0a3 3 0 0 0 -6 0"></path><path
          d="M17.657 16.657l-4.243 4.243a2 2 0 0 1 -2.827 0l-4.244 -4.243a8 8 0 1 1 11.314 0"
        ></path></svg
      >
      Currently based in
    </span>
    <span class="group relative inline-flex items-center">
      <span class="sr-only">Built with Leaflet</span>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="var(--foreground)"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="icon icon-tabler icons-tabler-outline icon-tabler-info-circle"
      >
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0"></path>
        <path d="M12 9h.01"></path>
        <path d="M11 12h1v4h1"></path>
      </svg>
      <span
        class="bg-background text-foreground pointer-events-none absolute top-1/2 right-full z-10 mr-2 -translate-y-1/2 rounded px-2 py-1 text-[0.65rem] whitespace-nowrap opacity-0 shadow transition-opacity duration-150 group-hover:opacity-100"
      >
        Built with Leaflet
      </span>
    </span>
  </h3>
  <div id="map" class="h-full w-full flex-1 rounded-md"></div>
  <div class="pointer-events-none absolute bottom-2 left-2 z-1000">
    <div
      class="bg-card/80 text-foreground flex items-center gap-2 rounded-md px-2 py-1 text-xs"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="14"
        height="14"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="text-primary"
      >
        <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path>
        <circle cx="12" cy="10" r="3"></circle>
      </svg>
      <span>{label}</span>
    </div>
  </div>
</div>

<script is:inline>
  const LEAFLET_CSS_URL = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.css";
  const LEAFLET_JS_URL = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
  const LEAFLET_CSS_INTEGRITY =
    "sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=";
  const LEAFLET_JS_INTEGRITY =
    "sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=";

  const loadLeafletCss = () =>
    new Promise((resolve) => {
      const existing = document.querySelector("link[data-leaflet-css='true']");
      if (existing) {
        resolve();
        return;
      }

      const link = document.createElement("link");
      link.rel = "stylesheet";
      link.href = LEAFLET_CSS_URL;
      link.integrity = LEAFLET_CSS_INTEGRITY;
      link.crossOrigin = "";
      link.dataset.leafletCss = "true";
      link.onload = () => resolve();
      link.onerror = () => resolve();
      document.head.appendChild(link);
    });

  const loadLeafletScript = () =>
    new Promise((resolve) => {
      const existing = document.querySelector("script[data-leaflet-js='true']");
      if (existing) {
        if (window.L) {
          resolve();
        } else {
          existing.addEventListener("load", () => resolve(), { once: true });
          existing.addEventListener("error", () => resolve(), { once: true });
        }
        return;
      }

      const script = document.createElement("script");
      script.src = LEAFLET_JS_URL;
      script.integrity = LEAFLET_JS_INTEGRITY;
      script.crossOrigin = "";
      script.dataset.leafletJs = "true";
      script.onload = () => resolve();
      script.onerror = () => resolve();
      document.body.appendChild(script);
    });

  const ensureLeafletLoaded = async () => {
    await Promise.all([loadLeafletCss(), loadLeafletScript()]);
  };

  const initLocationMap = () => {
    const container = document.getElementById("location-map");
    const mapElement = document.getElementById("map");

    if (!container || !mapElement || !window.L) {
      return;
    }

    if (mapElement._leaflet_id) {
      mapElement._leaflet_id = undefined;
      mapElement.innerHTML = "";
    }

    const lat = Number.parseFloat(container.dataset.lat || "52.4064");
    const lng = Number.parseFloat(container.dataset.lng || "16.9252");
    const zoom = Number.parseInt(container.dataset.zoom || "12", 10);

    const map = L.map("map", {
      zoomControl: false,
      attributionControl: false,
    }).setView([lat, lng], zoom);

    // Dark theme tile layer
    L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
      {
        maxZoom: 19,
      },
    ).addTo(map);
  };

  const setupMapObserver = () => {
    const container = document.getElementById("location-map");
    if (!container) return;
    if (container.dataset.mapLoaded === "true") return;

    const observer = new IntersectionObserver(
      (entries) => {
        const entry = entries[0];
        if (!entry?.isIntersecting) return;
        observer.disconnect();
        container.dataset.mapLoaded = "true";

        ensureLeafletLoaded()
          .then(() => initLocationMap())
          .catch(() => undefined);
      },
      { rootMargin: "200px" },
    );

    observer.observe(container);
  };

  document.addEventListener("DOMContentLoaded", setupMapObserver);
  document.addEventListener("astro:page-load", setupMapObserver);
</script>

<style>
  .custom-marker {
    background: transparent;
    border: none;
  }
</style>
